---
import readFile from "@/server/readFile";
import type {HTMLAttributes} from "astro/types";

interface Props extends HTMLAttributes<"img"> {
  id?: string;
  alt: string;
  width?: number;
  height?: number;
  lazy?: boolean;
  params?: Record<string, string>;
  defaultSrc?: string;
}

const {
  id,
  alt,
  width: wP,
  height: hP,
  lazy = true,
  params,
  defaultSrc,
  ...props
} = Astro.props;

const queryParams = {
  ...(wP ? {width: String(wP).trim()} : {}),
  ...(hP ? {height: String(hP).trim()} : {}),
  ...params,
};

let file: string | undefined;
if (id) {
  file = await readFile({id, name: alt, params: queryParams});
}

const src = () => file?.trim() || (defaultSrc ?? "/assets/images/image-default.webp");
---

<img {...props} src={src()} alt={alt} loading={lazy ? "lazy" : "eager"}/>
